

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Handlers and Middleware &mdash; Desarrollo web en entorno servidor</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Índice"
              href="genindex.html"/>
        <link rel="search" title="Búsqueda" href="search.html"/>
    <link rel="top" title="Desarrollo web en entorno servidor" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Desarrollo web en entorno servidor
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Desarrollo web en entorno servidor</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Handlers and Middleware</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/ricpelo/dwes/blob/master/handlers-and-middleware.rst" class="fa fa-github"> Edit on GitHub</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="handlers-and-middleware">
<h1>Handlers and Middleware<a class="headerlink" href="#handlers-and-middleware" title="Enlazar permanentemente con este título">¶</a></h1>
<p>Guzzle clients use a handler and middleware system to send HTTP requests.</p>
<div class="section" id="handlers">
<h2>Handlers<a class="headerlink" href="#handlers" title="Enlazar permanentemente con este título">¶</a></h2>
<p>A handler function accepts a <code class="docutils literal"><span class="pre">Psr\Http\Message\RequestInterface</span></code> and array of
request options and returns a <code class="docutils literal"><span class="pre">GuzzleHttp\Promise\PromiseInterface</span></code> that is
fulfilled with a <code class="docutils literal"><span class="pre">Psr\Http\Message\ResponseInterface</span></code> or rejected with an
exception.</p>
<p>You can provide a custom handler to a client using the <code class="docutils literal"><span class="pre">handler</span></code> option of
a client constructor. It is important to understand that several request
options used by Guzzle require that specific middlewares wrap the handler used
by the client. You can ensure that the handler you provide to a client uses the
default middlewares by wrapping the handler in the
<code class="docutils literal"><span class="pre">GuzzleHttp\HandlerStack::create(callable</span> <span class="pre">$handler</span> <span class="pre">=</span> <span class="pre">null)</span></code> static method.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>

<span class="nv">$handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">();</span>
<span class="nv">$stack</span> <span class="o">=</span> <span class="nx">HandlerStack</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$handler</span><span class="p">);</span> <span class="c1">// Wrap w/ middleware</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">create</span></code> method adds default handlers to the <code class="docutils literal"><span class="pre">HandlerStack</span></code>. When the
<code class="docutils literal"><span class="pre">HandlerStack</span></code> is resolved, the handlers will execute in the following order:</p>
<ol class="arabic simple">
<li>Sending request:</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">http_errors</span></code> - No op when sending a request. The response status code
is checked in the response processing when returning a response promise up
the stack.</li>
<li><code class="docutils literal"><span class="pre">allow_redirects</span></code> - No op when sending a request. Following redirects
occurs when a response promise is being returned up the stack.</li>
<li><code class="docutils literal"><span class="pre">cookies</span></code> - Adds cookies to requests.</li>
<li><code class="docutils literal"><span class="pre">prepare_body</span></code> - The body of an HTTP request will be prepared (e.g.,
add default headers like Content-Length, Content-Type, etc.).</li>
<li>&lt;send request with handler&gt;</li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Processing response:</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">prepare_body</span></code> - no op on response processing.</li>
<li><code class="docutils literal"><span class="pre">cookies</span></code> - extracts response cookies into the cookie jar.</li>
<li><code class="docutils literal"><span class="pre">allow_redirects</span></code> - Follows redirects.</li>
<li><code class="docutils literal"><span class="pre">http_errors</span></code> - throws exceptions when the response status code <code class="docutils literal"><span class="pre">&gt;=</span></code>
300.</li>
</ol>
</div></blockquote>
<p>When provided no <code class="docutils literal"><span class="pre">$handler</span></code> argument, <code class="docutils literal"><span class="pre">GuzzleHttp\HandlerStack::create()</span></code>
will choose the most appropriate handler based on the extensions available on
your system.</p>
<div class="admonition important">
<p class="first admonition-title">Importante</p>
<p class="last">The handler provided to a client determines how request options are applied
and utilized for each request sent by a client. For example, if you do not
have a cookie middleware associated with a client, then setting the
<code class="docutils literal"><span class="pre">cookies</span></code> request option will have no effect on the request.</p>
</div>
</div>
<div class="section" id="middleware">
<h2>Middleware<a class="headerlink" href="#middleware" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Middleware augments the functionality of handlers by invoking them in the
process of generating responses. Middleware is implemented as a higher order
function that takes the following form.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">my_middleware</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">callable</span> <span class="nv">$handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$handler</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Middleware functions return a function that accepts the next handler to invoke.
This returned function then returns another function that acts as a composed
handler&#8211; it accepts a request and options, and returns a promise that is
fulfilled with a response. Your composed middleware can modify the request,
add custom request options, and modify the promise returned by the downstream
handler.</p>
<p>Here&#8217;s an example of adding a header to each request.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">add_header</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">callable</span> <span class="nv">$handler</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span>
            <span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span>
            <span class="k">array</span> <span class="nv">$options</span>
        <span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$handler</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once a middleware has been created, you can add it to a client by either
wrapping the handler used by the client or by decorating a handler stack.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">add_header</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">));</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>Now when you send a request, the client will use a handler composed with your
added middleware, adding a header to each request.</p>
<p>Here&#8217;s an example of creating a middleware that modifies the response of the
downstream handler. This example adds a header to the response.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>

<span class="k">function</span> <span class="nf">add_response_header</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">function</span> <span class="p">(</span><span class="nx">callable</span> <span class="nv">$handler</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">function</span> <span class="p">(</span>
            <span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">,</span>
            <span class="k">array</span> <span class="nv">$options</span>
        <span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$handler</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$promise</span> <span class="o">=</span> <span class="nv">$handler</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$promise</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span>
                <span class="k">function</span> <span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">);</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">add_response_header</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">));</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>Creating a middleware that modifies a request is made much simpler using the
<code class="docutils literal"><span class="pre">GuzzleHttp\Middleware::mapRequest()</span></code> middleware. This middleware accepts
a function that takes the request argument and returns the request to send.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
<span class="p">}));</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
<p>Modifying a response is also much simpler using the
<code class="docutils literal"><span class="pre">GuzzleHttp\Middleware::mapResponse()</span></code> middleware.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\ResponseInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Handler\CurlHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">CurlHandler</span><span class="p">());</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapResponse</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">ResponseInterface</span> <span class="nv">$response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
<span class="p">}));</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="section" id="handlerstack">
<h2>HandlerStack<a class="headerlink" href="#handlerstack" title="Enlazar permanentemente con este título">¶</a></h2>
<p>A handler stack represents a stack of middleware to apply to a base handler
function. You can push middleware to the stack to add to the top of the stack,
and unshift middleware onto the stack to add to the bottom of the stack. When
the stack is resolved, the handler is pushed onto the stack. Each value is
then popped off of the stack, wrapping the previous value popped off of the
stack.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\HandlerStack</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Client</span><span class="p">;</span>

<span class="nv">$stack</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HandlerStack</span><span class="p">();</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">setHandler</span><span class="p">(</span><span class="nx">\GuzzleHttp\choose_handler</span><span class="p">());</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;A&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">});</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;B&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">});</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;C&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">});</span>

<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;http://httpbin.org/&#39;</span><span class="p">);</span>
<span class="c1">// echoes &#39;ABC&#39;;</span>

<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">unshift</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
<span class="p">});</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">([</span><span class="s1">&#39;handler&#39;</span> <span class="o">=&gt;</span> <span class="nv">$stack</span><span class="p">]);</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;http://httpbin.org/&#39;</span><span class="p">);</span>
<span class="c1">// echoes &#39;0ABC&#39;;</span>
</pre></div>
</div>
<p>You can give middleware a name, which allows you to add middleware before
other named middleware, after other named middleware, or remove middleware
by name.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">Psr\Http\Message\RequestInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">GuzzleHttp\Middleware</span><span class="p">;</span>

<span class="c1">// Add a middleware with a name</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">(</span><span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">);</span>
<span class="p">},</span> <span class="s1">&#39;add_foo&#39;</span><span class="p">);</span>

<span class="c1">// Add a middleware before a named middleware (unshift before).</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="s1">&#39;add_foo&#39;</span><span class="p">,</span> <span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Baz&#39;</span><span class="p">,</span> <span class="s1">&#39;Qux&#39;</span><span class="p">);</span>
<span class="p">},</span> <span class="s1">&#39;add_baz&#39;</span><span class="p">);</span>

<span class="c1">// Add a middleware after a named middleware (pushed after).</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">after</span><span class="p">(</span><span class="s1">&#39;add_baz&#39;</span><span class="p">,</span> <span class="nx">Middleware</span><span class="o">::</span><span class="na">mapRequest</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">RequestInterface</span> <span class="nv">$r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$r</span><span class="o">-&gt;</span><span class="na">withHeader</span><span class="p">(</span><span class="s1">&#39;X-Lorem&#39;</span><span class="p">,</span> <span class="s1">&#39;Ipsum&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Remove a middleware by name</span>
<span class="nv">$stack</span><span class="o">-&gt;</span><span class="na">remove</span><span class="p">(</span><span class="s1">&#39;add_foo&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-a-handler">
<h2>Creating a Handler<a class="headerlink" href="#creating-a-handler" title="Enlazar permanentemente con este título">¶</a></h2>
<p>As stated earlier, a handler is a function accepts a
<code class="docutils literal"><span class="pre">Psr\Http\Message\RequestInterface</span></code> and array of request options and returns
a <code class="docutils literal"><span class="pre">GuzzleHttp\Promise\PromiseInterface</span></code> that is fulfilled with a
<code class="docutils literal"><span class="pre">Psr\Http\Message\ResponseInterface</span></code> or rejected with an exception.</p>
<p>A handler is responsible for applying the following <a class="reference internal" href="request-options.html"><span class="doc">Request Options</span></a>.
These request options are a subset of request options called
&#8220;transfer options&#8221;.</p>
<ul class="simple">
<li><a class="reference internal" href="request-options.html#cert-option"><span class="std std-ref">cert</span></a></li>
<li><a class="reference internal" href="request-options.html#connect-timeout-option"><span class="std std-ref">connect_timeout</span></a></li>
<li><a class="reference internal" href="request-options.html#debug-option"><span class="std std-ref">debug</span></a></li>
<li><a class="reference internal" href="request-options.html#delay-option"><span class="std std-ref">delay</span></a></li>
<li><a class="reference internal" href="request-options.html#decode-content-option"><span class="std std-ref">decode_content</span></a></li>
<li><a class="reference internal" href="request-options.html#expect-option"><span class="std std-ref">expect</span></a></li>
<li><a class="reference internal" href="request-options.html#proxy-option"><span class="std std-ref">proxy</span></a></li>
<li><a class="reference internal" href="request-options.html#sink-option"><span class="std std-ref">sink</span></a></li>
<li><a class="reference internal" href="request-options.html#timeout-option"><span class="std std-ref">timeout</span></a></li>
<li><a class="reference internal" href="request-options.html#ssl-key-option"><span class="std std-ref">ssl_key</span></a></li>
<li><a class="reference internal" href="request-options.html#stream-option"><span class="std std-ref">stream</span></a></li>
<li><a class="reference internal" href="request-options.html#verify-option"><span class="std std-ref">verify</span></a></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Ricardo Pérez López.
      Actualizado por última vez en 07-02-2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>